@model OnlineFoodOrdering.Models.Entity.Cart

@{
    ViewData["Title"] = "View Cart";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<!-- Add this script tag to include jQuery -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<script>
    $(document).ready(function () {
        $(".quantity-control").on("click", function () {
            var action = $(this).data("action");
            var inputField = $(this).siblings(".quantity-input");
            var currentValue = parseInt(inputField.val());

            if (action === "increment") {
                inputField.val(currentValue + 1);
            } else if (action === "decrement" && currentValue > 1) {
                inputField.val(currentValue - 1);
            }

            // Send AJAX request to update quantity on the server
            updateCartItemQuantity(inputField);
        });

        function updateCartItemQuantity(inputField) {
            var form = inputField.closest("form");
            var formData = form.serialize();

            $.ajax({
                type: "POST",
                url: form.attr("action"),
                data: formData,
                success: function () {
                    // Optionally, you can update the total and grand total on the page
                },
                error: function (error) {
                    console.error("Error updating quantity: ", error);
                }
            });
        }
    });
</script>

<div class="container mt-5">
    <h1>Your Cart</h1>
    @if (Model != null && Model.CartItems.Any())
    {
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Food Name</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Total</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @{
                    double grandTotal = 0; // Initialize grand total outside the loop
                }
                @foreach (var cartItem in Model.CartItems)
                {
                    var itemTotal = cartItem.Quantity * cartItem.Food.Price;
                    grandTotal += itemTotal;
                    <tr>
                        <td>@cartItem.Food.FoodName</td>
                        <td>
                            <form asp-controller="Order" asp-action="UpdateCartItemQuantity" method="post" class="d-flex align-items-center">
                                <input type="hidden" name="foodId" value="@cartItem.FoodId" />
                                <button type="button" class="btn btn-sm btn-secondary quantity-control" data-action="decrement">-</button>
                                <input type="number" name="quantity" value="@cartItem.Quantity" min="1" class="form-control quantity-input" />
                                <button type="button" class="btn btn-sm btn-secondary quantity-control" data-action="increment">+</button>
                                <!-- Remove the 'Update' button -->
                            </form>
                        </td>
                        <td>@cartItem.Food.Price</td>
                        <td>@(cartItem.Quantity * cartItem.Food.Price)</td>
                        <td>
                            <form asp-controller="Order" asp-action="RemoveCartItem" method="post">
                                <input type="hidden" name="foodId" value="@cartItem.FoodId" />
                                <button type="submit" class="btn btn-sm btn-danger">Remove</button>
                            </form>
                        </td>
                    </tr>
                }
                <p>Grand Total : @grandTotal</p>
            </tbody>
        </table>
        <div class="mt-4">
            <h2>Payment Methods</h2>
            <form asp-controller="Order" asp-action="PlaceOrder" method="post">
                <div class="form-check">
                    <input type="radio" name="paymentMethod" value="esewa" class="form-check-input" id="esewaRadio" required />
                    <label class="form-check-label" for="esewaRadio">Pay via eSewa</label>
                </div>
                <div class="form-check">
                    <input type="radio" name="paymentMethod" value="khati" class="form-check-input" id="khatiRadio" required />
                    <label class="form-check-label" for="khatiRadio">Pay via Khati</label>
                </div>
                <div class="form-check">
                    <input type="radio" name="paymentMethod" value="namk" class="form-check-input" id="namkRadio" required />
                    <label class="form-check-label" for="namkRadio">Pay via Bank</label>
                </div>
                <div class="form-check">
                    <input type="radio" name="paymentMethod" value="cod" class="form-check-input" id="codRadio" required />
                    <label class="form-check-label" for="codRadio">Cash on Delivery</label>
                </div>

                <!-- New section for delivery address -->
                <div class="mt-3">
                    <label for="deliveryAddress" class="form-label">Delivery Address:</label>
                    <input type="text" name="deliveryAddress" class="form-control" required />
                </div>

                <button type="submit" class="btn btn-success mt-3">Place Order</button>
            </form>
            <div class="mt-4">
                <!-- Add a button to proceed to the payment page -->
                <a asp-controller="Order" asp-action="Payment" asp-route-cartId="@Model.CartId" class="btn btn-primary">Proceed to Payment</a>
            </div>
        </div>
    }
    else
    {
        <p class="text-center">Your cart is empty.</p>
    }
</div>
